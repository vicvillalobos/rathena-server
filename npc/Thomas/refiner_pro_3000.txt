//============================================================
// NPC  : Batch Refiner (sin UI) – v1.0 2025-05-22
// Mapa : prontera 156 180        |  Sprite 4_M_REPAIRMAN (416)
// Autor: ChatGPT (pedido de Thomas)
//============================================================
prontera,156,180,5	script	Refinador Batch	416,{

	//--------------------------------------------------------
	// 1) LISTAR SLOTS EQUIPADOS CON ÍTEMS REFINABLES
	//--------------------------------------------------------
	mes "[Refinador]";
	setarray .@check[0], EQI_HEAD_TOP, EQI_ARMOR, EQI_HAND_R, EQI_HAND_L,
	                   EQI_GARMENT, EQI_SHOES, EQI_HEAD_MID, EQI_HEAD_LOW;
	for (.@i = 0; .@i < getarraysize(.@check); .@i++) {
		.@slot = .@check[.@i];
		.@id   = getequipid(.@slot);
		.@cnt  = getequiprefinerycnt(.@slot);   // −1 si no refinable
		if (.@id <= 0 || .@cnt == -1) continue;
		.@menu$ += getitemname(.@id) + "  [+" + .@cnt + "]";
		.@slot_a[.@n] = .@slot;
		.@id_a[.@n]   = .@id;
		.@cnt_a[.@n]  = .@cnt;
		.@n++;
		.@menu$ += ":";
	}
	if (.@n == 0) { mes "No llevas nada que pueda refinar."; close; }

	//--------------------------------------------------------
	// 2) SELECCIONAR ÍTEM Y NIVEL OBJETIVO
	//--------------------------------------------------------
	.@pick    = select(.@menu$) - 1;
	.@slotSel = .@slot_a[.@pick];
	.@idSel   = .@id_a[.@pick];
	.@curRef  = .@cnt_a[.@pick];

	mes "Ítem:^0055FF " + getitemname(.@idSel) + "^000000 (+" + .@curRef + ")";
	mes "¿A qué nivel de refine quieres llegar?";
	input .@goal, .@curRef+1, 10;
	if (.@goal <= .@curRef) { mes "El refine objetivo debe ser mayor al actual."; close; }

	//--------------------------------------------------------
	// 3) ¿SÓLO EQUIPADO O TODAS LAS COPIAS?
	//--------------------------------------------------------
	.@invCopies = countitem(.@idSel);          // copias en inventario
	.@mode = 1;                                // 1 = sólo equipado
	if (.@invCopies) {
		mes "Tienes ^FF7700"+.@invCopies+"^000000 copias extra en inventario.";
		next;
		.@mode = select("Sólo el equipado:Refinar todos (equipo + copias)");
	}

	//--------------------------------------------------------
	// 4) REFINAR LA PIEZA EQUIPADA
	//--------------------------------------------------------
	callsub RefinaUno, .@slotSel, .@goal;

	//--------------------------------------------------------
	// 5) REFINAR COPIAS (si corresponde)
	//--------------------------------------------------------
	if (.@mode == 2) {
		set .@procesadas, 0;

		while (countitem(.@idSel) > 0) {

			// Asegura el slot libre y busca siguiente copia
			if (getequipid(.@slotSel)) unequip .@slotSel;

			getinventorylist;
			.@idx = -1;
			for (.@i = 0; .@i < @inventorylist_count; .@i++) {
				if (@inventorylist_id[.@i] == .@idSel) {
					.@idx = @inventorylist_index[.@i];
					break;
				}
			}
			if (.@idx == -1) break;           // no quedan copias

			equip .@idx;
			if (getequipid(.@slotSel) != .@idSel) break; // por seguridad

			callsub RefinaUno, .@slotSel, .@goal;
			.@procesadas++;
		}
		mes "[Refinador] "+.@procesadas+" copia(s) procesadas.";
	}

	mes "[Refinador] Trabajo finalizado.";
	close;

	//--------------------------------------------------------
	// ■ Sub-rutina RefinaUno – refina la pieza equipada en slot
	//--------------------------------------------------------
RefinaUno:
	.@slot = getarg(0);              // slot equipado
	.@goal = getarg(1);              // refine objetivo
	.@id   = getequipid(.@slot);
	if (.@id == 0) return;           // nada equipado

	.@tipo = getiteminfo(.@id, ITEMINFO_TYPE);
	.@lvlA = getiteminfo(.@id, ITEMINFO_EQUIP_LEVEL);

	while (getequiprefinerycnt(.@slot) < .@goal) {

		//— Material según tipo / nivel
		if (.@tipo == IT_ARMOR)            .@mat = 985;          // Elunium
		else if (.@lvlA == 1)              .@mat = 1010;         // Phracon
		else if (.@lvlA == 2)              .@mat = 1011;         // Emveretarcon
		else                               .@mat = 984;          // Oridecon

		if (countitem(.@mat) < 1) { dispbottom "[Falta] "+getitemname(.@mat); break; }
		delitem .@mat,1;

		.@actual = getequiprefinerycnt(.@slot);
		.@rate   = callsub Rate, .@tipo, .@lvlA, .@actual;

		if (rand(100) < .@rate) {
			successrefitem .@slot;
			dispbottom "[OK] "+getitemname(.@id)+" -> +"+(.@actual+1);
		} else {
			failedrefitem .@slot;
			dispbottom "[ROTO] "+getitemname(.@id);
			break;
		}
	}

	// Deja la pieza fuera (refinada o rota) para seguir el ciclo
	if (getequipid(.@slot) == .@id) unequip .@slot;
	return;

	//--------------------------------------------------------
	// ■ Rate – tabla de % de éxito (similar al refiner oficial)
	//--------------------------------------------------------
Rate:
	.@t   = getarg(0);
	.@lvl = getarg(1);
	.@cur = getarg(2);

	if (.@t == IT_ARMOR) {           // Armaduras
		return ( [0,100,100,100,70,50,40,30,20,10,5] )[.@cur];
	}

	// Armas lvl 1-4
	if (.@lvl == 1) return ( [0,100,100,100,90,80,70,60,40,20,10] )[.@cur];
	if (.@lvl == 2) return ( [0,100,100,100,90,70,50,40,30,20,10] )[.@cur];
	if (.@lvl == 3) return ( [0,100,100,100,80,60,40,20,15,10,5]  )[.@cur];
	/* lvl 4 */     return ( [0,100,100,100,70,50,30,15,10,5,3]   )[.@cur];
}
